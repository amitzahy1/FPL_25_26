<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FPL Ultimate Draft Tool</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh; padding: 15px; line-height: 1.4; max-width: 1400px; margin: 0 auto;
        }
        .header { text-align: center; margin-bottom: 20px; background: white; padding: 15px; border-radius: 12px; box-shadow: 0 6px 20px rgba(0,0,0,0.1); }
        h1 { color: #2c3e50; font-size: 1.8em; margin-bottom: 8px; font-weight: 700; }
        .subtitle { color: #7f8c8d; font-size: 1em; font-weight: 500; }
        .legend {
            background: #fff; padding: 12px; border-radius: 8px; text-align: center;
            margin-bottom: 20px; font-size: 0.9em; box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        }
        .legend-item { display: inline-block; margin: 0 10px; }
        .legend-title { font-weight: 600; cursor: help; border-bottom: 1px dotted #2c3e50; }
        .filters { background: white; padding: 15px; margin-bottom: 15px; border-radius: 12px; box-shadow: 0 6px 20px rgba(0,0,0,0.1); display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 12px; align-items: end; }
        .filter-group { display: flex; flex-direction: column; }
        label { font-weight: 600; margin-bottom: 4px; color: #2c3e50; font-size: 0.85em; }
        select, input { padding: 8px; border: 2px solid #ecf0f1; border-radius: 6px; font-size: 12px; transition: all 0.3s ease; }
        select:focus, input:focus { outline: none; border-color: #a1c4fd; box-shadow: 0 0 0 3px rgba(161, 196, 253, 0.2); }
        .controls { display: flex; gap: 10px; margin-bottom: 15px; justify-content: center; flex-wrap: wrap; }
        .control-button {
            background: linear-gradient(135deg, #e2e8f0 0%, #f1f5f9 100%); color: #475569;
            border: 1px solid #cbd5e1; padding: 8px 16px; border-radius: 8px; cursor: pointer;
            font-weight: 600; transition: all 0.3s ease; font-size: 0.85em;
        }
        .control-button:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%); }
        .control-button.active { background: linear-gradient(135deg, #a1c4fd 0%, #c2e9fb 100%); color: #333; border-color: #a1c4fd; }
        .table-container { background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 6px 20px rgba(0,0,0,0.1); overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 0.85em; } /* Font size updated */
        th { background: linear-gradient(135deg, #a1c4fd 0%, #c2e9fb 100%); color: #333; padding: 10px 6px; text-align: center; font-weight: 600; white-space: nowrap; cursor: pointer; user-select: none; transition: all 0.3s ease; position: sticky; top: 0; z-index: 10; }
        th:hover { background: linear-gradient(135deg, #8ab2f2 0%, #a1c4fd 100%); }
        th.sorted { background: linear-gradient(135deg, #8ab2f2 0%, #a1c4fd 100%); }
        td { padding: 8px 6px; border-bottom: 1px solid #f8f9fa; white-space: nowrap; text-align: center; } /* Bold removed */
        tr:hover { background: #f1f5f9; }
        .name-cell { color: #2c3e50; min-width: 100px; text-align:right; }
        .player-name-icon { margin-right: 5px; font-size: 0.9em; }
        .verbal-insights-cell { white-space: normal; font-size: 0.9em; line-height: 1.2; color: #5a6c7d; min-width: 150px; text-align: right;}
        .position-gkp { background-color: #fff3cd !important; }
        .position-def { background-color: #d1ecf1 !important; }
        .position-mid { background-color: #d4edda !important; }
        .position-fwd { background-color: #fed8b1 !important; } /* Changed from red to orange */
        .xdiff-positive { color: #27ae60; font-weight: 600; }
        .xdiff-negative { color: #e74c3c; font-weight: 600; }
        .sort-indicator { display: inline-block; margin-left: 3px; }
        .bold-cell { font-weight: 700; } /* Class for bolding specific cells */
        .modal {
            display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%;
            overflow: auto; background-color: rgba(0,0,0,0.4);
        }
        .modal-content {
            background-color: #fefefe; margin: 5% auto; padding: 20px; border: 1px solid #888;
            width: 90%; max-width: 1200px; border-radius: 12px;
        }
        .close { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        #compareTable th { background: linear-gradient(135deg, #c2e9fb 0%, #a1c4fd 100%); font-size: 1.1em;}
        #compareTable { width: auto; margin: 0 auto; border-collapse: separate; border-spacing: 0; }
        #compareTable th, #compareTable td { border: 1px solid #ddd; padding: 8px; }
        #compareTable td { font-size: 1.1em; }
        .value-best { background-color: #d4edda; }
        .value-good { background-color: #e2f0d9; }
        .value-mid { background-color: #fff2cc; }
        .value-bad { background-color: #f8d7da; }
        .value-worst { background-color: #f5c6cb; }
        .emoji-legend { background: white; padding: 15px; margin-bottom: 15px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .emoji-legend-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 8px; text-align: right; font-size: 0.85em;}
        .insights-list { list-style-type: none; padding-right: 0; margin-right: 0; text-align: right; }
        .insights-list li { margin-bottom: 3px; }
    </style>
</head>
<body>
    <div class="container">
    <div class="header">
            <h1>ğŸ† FPL Ultimate Draft Tool</h1>
            <p class="subtitle">× ×™×ª×•×— ×—×›× | ×¦×™×•×Ÿ ×“×¨××¤×˜ ×™×™×¢×•×“×™ | ×¡×™× ×•×Ÿ ××ª×§×“×</p>
        </div>
        <div class="legend">
            <p>
                <span class="legend-item"><strong class="legend-title" title="×¦×™×•×Ÿ ×™×™×¢×•×“×™ ×”××—×•×©×‘ ×œ×¤×™ ×¢××“×” ×œ×”×¢×¨×›×ª ×©×•×•×™ ×‘×“×¨××¤×˜. ××‘×•×¡×¡ ×¢×œ ××“×“×™× ×›××• xG, xA, ICT, BPS, ×©×¢×¨×™× × ×§×™×™× ×•×¢×•×“, ×¢× ××©×§×•×œ×•×ª ×©×•× ×•×ª ×œ×›×œ ×¢××“×”.">×¦×™×•×Ÿ ×“×¨××¤×˜</strong></span>
                <span class="legend-item"><strong class="legend-title" title="×”×”×¤×¨×© ×‘×™×Ÿ ×©×¢×¨×™× ×•×‘×™×©×•×œ×™× ×‘×¤×•×¢×œ (G+A) ×œ×‘×™×¦×•×¢ ×”×¦×¤×•×™ (xG+xA). ×¢×¨×š ×—×™×•×‘×™ (×™×¨×•×§) = ×‘×™×¦×•×¢×™ ×™×ª×¨ (××¢×œ ×”××¦×•×¤×”). ×¢×¨×š ×©×œ×™×œ×™ (××“×•×) = ×‘×™×¦×•×¢×™ ×—×¡×¨ (××ª×—×ª ×œ××¦×•×¤×”).">xDiff</strong></span>
                <span class="legend-item"><strong class="legend-title" title="××“×“ ×”×©×¤×¢×”, ×™×¦×™×¨×ª×™×•×ª ×•××™×•×">ICT</strong></span>
            </p>
    </div>
    <div class="filters">
            <div class="filter-group"><label>ğŸ” ×—×™×¤×•×© ×©×—×§×Ÿ:</label><input type="text" id="searchName" onkeyup="processChange()" placeholder="×©× ×©×—×§×Ÿ..."></div>
            <div class="filter-group"><label>âš½ ×¢××“×”:</label><select id="positionFilter" onchange="processChange()"><option value="">×›×œ ×”×¢××“×•×ª</option><option value="GKP">ğŸ¥… ×©×•×¢×¨×™×</option><option value="DEF">ğŸ›¡ï¸ ××’× ×™×</option><option value="MID">âš½ ×§×©×¨×™×</option><option value="FWD">ğŸ¯ ×—×œ×•×¦×™×</option></select></div>
            <div class="filter-group"><label>ğŸŸï¸ ×§×‘×•×¦×”:</label><select id="teamFilter" onchange="processChange()"><option value="">×›×œ ×”×§×‘×•×¦×•×ª</option></select></div>
            <div class="filter-group"><label>ğŸ’° ××—×™×¨ ×˜×•×•×—:</label><input type="text" id="priceRange" onkeyup="processChange()" placeholder="4.0-15.0"></div>
            <div class="filter-group"><label>ğŸ† × ×§×•×“×•×ª ××™× ×™××•×:</label><input type="number" id="minPoints" onkeyup="processChange()" placeholder="0"></div>
            <div class="filter-group"><label>ğŸ¯ ×˜×•×•×— xDiff:</label><select id="xDiffFilter" onchange="processChange()"><option value="">×›×œ ×”×˜×•×•×—</option><option value="positive">×—×™×•×‘×™ (×‘×™×¦×•×¢×™ ×™×ª×¨)</option><option value="negative">×©×œ×™×œ×™ (×‘×™×¦×•×¢×™ ×—×¡×¨)</option></select></div>
            <div class="filter-group"><label>×”×¦×’:</label><select id="showEntries" onchange="processChange()"><option value="50">50</option><option value="100">100</option><option value="200">200</option><option value="all" selected>×”×›×œ</option></select></div>
        </div>
    <div class="controls">
        <button class="control-button active" onclick="showAllPlayers(this)">×›×œ ×”×©×—×§× ×™×</button>
        <button class="control-button" id="compareBtn" onclick="compareSelectedPlayers()">×”×©×•×•×” ×©×—×§× ×™× × ×‘×—×¨×™×</button>
        <button class="control-button" data-filter-name="set_pieces" onclick="quickFilter(this, 'set_pieces')" title="××¦×™×’ ×©×—×§× ×™× ×©×œ×•×§×—×™× ×¤× ×“×œ×™×, ×§×¨× ×•×ª ××• ×‘×¢×™×˜×•×ª ×—×•×¤×©×™×•×ª, ×¢×œ ×‘×¡×™×¡ ×”× ×ª×•× ×™× ×©×–×•×”×•. ×××•×™×Ÿ ×œ×¤×™ ×¦×™×•×Ÿ ×“×¨××¤×˜.">ğŸ¯ ×‘×•×¢×˜×™ ××¦×‘×™× × ×™×™×—×™×</button>
        <button class="control-button" data-filter-name="attacking_defenders" onclick="quickFilter(this, 'attacking_defenders')" title="××¦×™×’ ×©×—×§× ×™ ×”×’× ×” ×¢× × ×ª×•× ×™ xGI/90 ×’×‘×•×”×™×, ×©×©×™×—×§×• ××¢×œ 300 ×“×§×•×ª. ×”××™×•×Ÿ ×”×•× ×œ×¤×™ ×¦×™×•×Ÿ ×“×¨××¤×˜.">ğŸ›¡ï¸ ××’× ×™× ×ª×•×§×¤×™×</button>
        <button class="control-button" data-filter-name="underperformers" onclick="quickFilter(this, 'underperformers')" title="××¦×™×’ ×©×—×§× ×™× ×©×©×™×—×§×• ××¢×œ 300 ×“×§×•×ª ×•×”-xDiff ×©×œ×”× × ××•×š ×-1.5-. ×”××™×•×Ÿ ×”×•× ×œ×¤×™ ×¦×™×•×Ÿ ×“×¨××¤×˜.">ğŸ“‰ ×‘×™×¦×•×¢×™ ×—×¡×¨</button>
        <button class="control-button" data-filter-name="overperformers" onclick="quickFilter(this, 'overperformers')" title="××¦×™×’ ×©×—×§× ×™× ×©×©×™×—×§×• ××¢×œ 300 ×“×§×•×ª ×•×”-xDiff ×©×œ×”× ×’×‘×•×” ×-2.5. ×”××™×•×Ÿ ×”×•× ×œ×¤×™ ×¦×™×•×Ÿ ×“×¨××¤×˜.">ğŸ“ˆ ×‘×™×¦×•×¢×™ ×™×ª×¨</button>
        <button class="control-button" data-filter-name="differentials" onclick="quickFilter(this, 'differentials')" title="××¦×™×’ ×©×—×§× ×™× ×¢× ××—×•×– ×”×—×–×§×” × ××•×š ×-5%. ×”××™×•×Ÿ ×”×•× ×œ×¤×™ ×¦×™×•×Ÿ ×“×¨××¤×˜.">ğŸ’ ××¦×™××•×ª (×¢×“ 5%)</button>
        <button class="control-button" data-filter-name="newcomers" onclick="quickFilter(this, 'newcomers')" title="××¦×™×’ ×©×—×§× ×™× ×œ×œ× ×“×§×•×ª ××©×—×§ ×‘×¢×•× ×” ×©×¢×‘×¨×”. ×”××™×•×Ÿ ×”×•× ×œ×¤×™ ×¦×™×•×Ÿ '×”×™×™×¤' ×”××‘×•×¡×¡ ×¢×œ ××—×™×¨ ×•××—×•×– ×”×—×–×§×”.">ğŸŒŸ ×ª×’×œ×™×•×ª ×”×¢×•× ×”</button>
        <button class="control-button" onclick="exportToCsv()">ğŸ“ ×™×¦×•× CSV</button>
    </div>

    <div class="emoji-legend">
        <strong>××§×¨× ××™×™×§×•× ×™×:</strong>
        <div class="emoji-legend-grid">
            <div><span>ğŸ¯</span> - ×‘×•×¢×˜ ×¤× ×“×œ×™×</div>
            <div><span>âš½</span> - ×œ×•×§×— ×§×¨× ×•×ª</div>
            <div><span>ğŸ‘Ÿ</span> - ×‘×•×¢×˜ ×—×•×¤×©×™×•×ª</div>
            <div><span>ğŸ’</span> - ×“×™×¤×¨× ×¦×™××œ (&lt;5% ×”×—×–×§×”)</div>
            <div><span>ğŸ’°</span> - ×ª××•×¨×” ×œ××—×™×¨ (Value)</div>
            <div><span>ğŸŒŸ</span> - ×©×—×§×Ÿ ×—×“×©/×œ×œ× ×“×§×•×ª</div>
            <div><span>ğŸ“‰</span> - ×‘×™×¦×•×¢×™ ×—×¡×¨ (xDiff ×©×œ×™×œ×™)</div>
            <div><span>ğŸ“ˆ</span> - ×‘×™×¦×•×¢×™ ×™×ª×¨ (xDiff ×—×™×•×‘×™)</div>
        </div>
    </div>
    
    <div class="table-container">
        <table id="playersTable">
            <thead>
                <tr>
                    <th onclick="sortTable(0)">×“×™×¨×•×’<span class="sort-indicator"></span></th>
                    <th onclick="sortTable(1)">×©×—×§×Ÿ<span class="sort-indicator"></span></th>
                    <th onclick="sortTable(2)">×¦×™×•×Ÿ ×“×¨××¤×˜<span class="sort-indicator"></span></th>
                    <th onclick="sortTable(3)">×§×‘×•×¦×”<span class="sort-indicator"></span></th>
                    <th onclick="sortTable(4)">×¢××“×”<span class="sort-indicator"></span></th>
                    <th onclick="sortTable(5)">××—×™×¨<span class="sort-indicator"></span></th>
                    <th onclick="sortTable(6)">× ×§×•×“×•×ª<span class="sort-indicator"></span></th>
                    <th onclick="sortTable(7)">× ×§'/××©×—×§<span class="sort-indicator"></span></th>
                    <th onclick="sortTable(8)">% ×‘×—×™×¨×”<span class="sort-indicator"></span></th>
                    <th onclick="sortTable(9)">×©×¢×¨+×‘×™×©×•×œ<span class="sort-indicator"></span></th>
                    <th onclick="sortTable(10)">xG+xA<span class="sort-indicator"></span></th>
                    <th onclick="sortTable(11)">×“×§×•×ª<span class="sort-indicator"></span></th>
                    <th onclick="sortTable(12)">xDiff<span class="sort-indicator"></span></th>
                    <th onclick="sortTable(13)">BPS<span class="sort-indicator"></span></th>
                    <th onclick="sortTable(14)">ICT<span class="sort-indicator"></span></th>
                    <th onclick="sortTable(15)">×‘×•× ×•×¡<span class="sort-indicator"></span></th>
                    <th onclick="sortTable(16)">×¨×©×ª × ×§×™×™×”<span class="sort-indicator"></span></th>
                    <th onclick="sortTable(17)">×—×•×¤×©×™×•×ª<span class="sort-indicator"></span></th>
                    <th onclick="sortTable(18)">×ª×•×‘× ×•×ª<span class="sort-indicator"></span></th>
                    <th>×‘×—×¨</th>
                </tr>
            </thead>
            <tbody id="playersTableBody"></tbody>
        </table>
    </div>

    <div id="compareModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <h2>×”×©×•×•××ª ×©×—×§× ×™×</h2>
            <div class="table-container">
                <table id="compareTable"></table>
            </div>
        </div>
    </div>

    </div>
    <script>
        let allPlayersData = [];
        let teamsData = {};
        let displayedData = [];
        let sortColumn = 2; // Default sort by Draft Score
        let sortDirection = 'desc';
        let activeQuickFilterName = null;
        let selectedForComparison = new Set();
        
        document.addEventListener('DOMContentLoaded', () => {
            fetchAndProcessData();
            setupEventListeners();
        });

        async function fetchAndProcessData() {
            try {
                const [jsonResponse, csvResponse] = await Promise.all([
                    fetch('FPL_Bootstrap_static.json'),
                    fetch('Lineups and More Data/SetPieceTakerSS.csv')
                ]);

                if (!jsonResponse.ok) throw new Error(`Failed to fetch JSON: ${jsonResponse.statusText}`);
                if (!csvResponse.ok) throw new Error(`Failed to fetch CSV: ${csvResponse.statusText}`);
                
                const data = await jsonResponse.json();
                const csvText = await csvResponse.text();
                const setPieceTakers = parseSetPieceCSV(csvText);
                
                teamsData = data.teams.reduce((acc, team) => {
                    acc[team.id] = team.name;
                    return acc;
                }, {});

                allPlayersData = preprocessPlayerData(data.elements, setPieceTakers);
                
                populateTeamFilter();
                processChange(); // Initial render with default sort
            } catch (error) {
                console.error('Error fetching or processing data:', error);
                document.getElementById('playersTableBody').innerHTML = '<tr><td colspan="20">Error loading data. Please try again.</td></tr>';
            }
        }
        
        function parseSetPieceCSV(csvText) {
            const takersByTeam = {};
            const lines = csvText.split(/\r?\n/).slice(1); // Split by newline, skip header
            let currentTeam = '';

            // Initialize all teams first to have the arrays
            lines.forEach(line => {
                const teamName = line.split(',')[0].trim();
                if (teamName && !takersByTeam[teamName]) {
                    takersByTeam[teamName] = { penalties: [], freekicks: [], corners: [] };
                }
            });

            // Now populate them
            lines.forEach(line => {
                const columns = line.split(',').map(s => s.trim());
                const teamName = columns[0];

                if (teamName) {
                    currentTeam = teamName;
                }

                if (!currentTeam || !takersByTeam[currentTeam]) return;

                const penaltyTaker = columns[1];
                const freekickTaker = columns[2];
                const cornerTaker = columns[3];

                if (penaltyTaker) takersByTeam[currentTeam].penalties.push(penaltyTaker);
                if (freekickTaker) takersByTeam[currentTeam].freekicks.push(freekickTaker);
                if (cornerTaker) takersByTeam[currentTeam].corners.push(cornerTaker);
            });
            
            // Now, slice to get top 2 and normalize names
            for (const team in takersByTeam) {
                takersByTeam[team].penalties = takersByTeam[team].penalties.slice(0, 2).map(name => name.replace(//g, 'O'));
                takersByTeam[team].freekicks = takersByTeam[team].freekicks.slice(0, 2).map(name => name.replace(//g, 'O'));
                takersByTeam[team].corners = takersByTeam[team].corners.slice(0, 2).map(name => name.replace(//g, 'O'));
            }

            return takersByTeam;
        }

        function getPositionName(elementTypeId) {
            switch (elementTypeId) {
                case 1: return 'GKP';
                case 2: return 'DEF';
                case 3: return 'MID';
                case 4: return 'FWD';
                default: return 'Unknown';
            }
        }
        
        function preprocessPlayerData(players, setPieceTakers) {
            const positions = { 1: [], 2: [], 3: [], 4: [] };
            
            players.forEach(p => {
                if (p.element_type in positions) {
                    positions[p.element_type].push(p.now_cost / 10);
                }
            });

            const priceTiers = {};
            for (const posId in positions) {
                const prices = positions[posId].sort((a, b) => a - b);
                priceTiers[posId] = {
                    p95: getPercentile(prices, 95),
                    p80: getPercentile(prices, 80),
                    p50: getPercentile(prices, 50)
                };
            }

            const knownPenaltyTakers = ['Salah', 'Haaland', 'Saka', 'Palmer', 'Fernandes', 'Wilson', 'Ward-Prowse', 'Toney'];

            return players.map(p => {
                const minutes = p.minutes || 0;
                const gi = (p.goals_scored || 0) + (p.assists || 0);
                const xgi = parseFloat(p.expected_goal_involvements) || 0;

                p.xG_per90 = minutes > 0 ? (parseFloat(p.expected_goals) / minutes) * 90 : 0;
                p.xA_per90 = minutes > 0 ? (parseFloat(p.expected_assists) / minutes) * 90 : 0;
                p.xGI_per90 = minutes > 0 ? (parseFloat(p.expected_goal_involvements) / minutes) * 90 : 0;
                p.xGC_per90 = minutes > 0 ? (parseFloat(p.expected_goals_conceded) / minutes) * 90 : 0;
                p.ict_per_90 = minutes > 0 ? (parseFloat(p.ict_index) / minutes) * 90 : 0;

                p.xDiff = gi - xgi;
                p.now_cost = p.now_cost / 10;
                p.team_name = teamsData[p.team];
                p.position_name = getPositionName(p.element_type);
                
                // Set piece data from CSV
                const playerSetPieces = setPieceTakers[p.team_name] || { penalties: [], freekicks: [], corners: [] };
                p.takes_penalties = playerSetPieces.penalties.some(name => p.web_name.toLowerCase() === name.toLowerCase());
                p.takes_corners = playerSetPieces.corners.some(name => p.web_name.toLowerCase() === name.toLowerCase());
                p.takes_free_kicks = playerSetPieces.freekicks.some(name => p.web_name.toLowerCase() === name.toLowerCase());
                
                const tiers = priceTiers[p.element_type];
                if (p.now_cost >= tiers.p95) p.price_tier = 'Elite';
                else if (p.now_cost >= tiers.p80) p.price_tier = 'Premium';
                else if (p.now_cost >= tiers.p50) p.price_tier = 'Mid-range';
                else p.price_tier = 'Budget';

                let draft_score = 0;
                if (minutes === 0) { // Newcomer - more conservative score
                    draft_score = (p.now_cost * 4) + (parseFloat(p.selected_by_percent) * 1.5); // Reduced impact of selection %
                } else if (minutes > 0 && minutes < 90) { // Low minutes player - conservative score
                    draft_score = p.total_points * 1.5;
                }
                else { // Existing player
                    draft_score = p.points_per_game * 10 + p.ict_per_90 * 2 + p.xGI_per90 * 20;
                    if (p.position_name === 'GKP' || p.position_name === 'DEF') {
                        draft_score -= p.xGC_per90 * 15;
                    }
                }
                p.draft_score = Math.max(0, draft_score); // Cap score at 0

                return p;
            });
        }

        function getPercentile(sortedArr, percentile) {
            if (!sortedArr.length) return 0;
            const index = (percentile / 100) * (sortedArr.length - 1);
            const floor = Math.floor(index);
            const ceil = Math.ceil(index);
            if (floor === ceil) return sortedArr[floor];
            const d0 = sortedArr[floor] * (ceil - index);
            const d1 = sortedArr[ceil] * (index - floor);
            return d0 + d1;
        }

        function setupEventListeners() {
            document.getElementById('searchName').addEventListener('keyup', processChange);
            document.getElementById('positionFilter').addEventListener('change', processChange);
            document.getElementById('teamFilter').addEventListener('change', processChange);
            document.getElementById('priceRange').addEventListener('keyup', processChange);
            document.getElementById('minPoints').addEventListener('keyup', processChange);
            document.getElementById('xDiffFilter').addEventListener('change', processChange);
            document.getElementById('showEntries').addEventListener('change', processChange);
        }

        function populateTeamFilter() {
            const teamFilter = document.getElementById('teamFilter');
            const uniqueTeams = [...new Set(allPlayersData.map(p => p.team_name))].sort();
            uniqueTeams.forEach(team => teamFilter.add(new Option(team, team)));
        }

        function renderTable() {
            const tbody = document.getElementById('playersTableBody');
            const showCount = document.getElementById('showEntries').value;
            const dataToRender = showCount === 'all' ? displayedData : displayedData.slice(0, parseInt(showCount));
            tbody.innerHTML = '';
            
            dataToRender.forEach((p, index) => {
                const row = tbody.insertRow();
                row.className = `position-${p.position_name.toLowerCase()}`;
                
                const xDiffClass = p.xDiff > 0 ? 'xdiff-positive' : p.xDiff < 0 ? 'xdiff-negative' : '';
                
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td class="name-cell">${generatePlayerIcons(p)}${p.web_name}</td>
                    <td class="bold-cell">${p.draft_score.toFixed(1)}</td>
                    <td>${p.team_name}</td>
                    <td>${p.position_name}</td>
                    <td>Â£${p.now_cost.toFixed(1)}</td>
                    <td class="bold-cell">${p.total_points}</td>
                    <td>${p.points_per_game}</td>
                    <td>${p.selected_by_percent}%</td>
                    <td>${(p.goals_scored || 0) + (p.assists || 0)}</td>
                    <td>${p.expected_goal_involvements}</td>
                    <td>${p.minutes}</td>
                    <td class="${xDiffClass}">${p.xDiff.toFixed(2)}</td>
                    <td>${p.bps}</td>
                    <td>${p.ict_index}</td>
                    <td>${p.bonus}</td>
                    <td>${p.clean_sheets}</td>
                    <td>${p.takes_free_kicks ? 'âœ”ï¸' : 'âŒ'}</td>
                    <td class="verbal-insights-cell">${generateVerbalInsights(p)}</td>
                    <td><input type="checkbox" class="compare-checkbox" data-player-id="${p.id}" onchange="toggleCompare(${p.id})"></td>
                `;
            });
        }

        function generatePlayerIcons(p) {
            const icons = [];
            if (p.takes_penalties) icons.push(`<span class='player-name-icon'>ğŸ¯</span>`);
            if (p.takes_corners) icons.push(`<span class='player-name-icon'>âš½</span>`);
            if (p.takes_free_kicks) icons.push(`<span class='player-name-icon'>ğŸ‘Ÿ</span>`);
            if (parseFloat(p.selected_by_percent) < 5) icons.push(`<span class='player-name-icon'>ğŸ’</span>`);
            if (p.price_tier === 'Budget' && p.points_per_game > 3.5) icons.push(`<span class='player-name-icon'>ğŸ’°</span>`);
            if (p.minutes === 0) icons.push(`<span class='player-name-icon'>ğŸŒŸ</span>`);
            if (p.xDiff < -0.5) icons.push(`<span class='player-name-icon'>ğŸ“‰</span>`);
            if (p.xDiff > 0.5) icons.push(`<span class='player-name-icon'>ğŸ“ˆ</span>`);
            return icons.join("");
        }
        
        function generateVerbalInsights(p) {
            const insights = [];
            if (p.takes_penalties) insights.push("<li>×‘×•×¢×˜ ×¤× ×“×œ×™×</li>");
            if (p.takes_corners) insights.push("<li>×œ×•×§×— ×§×¨× ×•×ª</li>");
            if (p.takes_free_kicks) insights.push("<li>×‘×•×¢×˜ ×—×•×¤×©×™×•×ª</li>");
            if (parseFloat(p.selected_by_percent) < 5 && p.minutes > 0) insights.push(`<li>×“×™×¤×¨× ×¦×™××œ (${p.selected_by_percent}%)</li>`);
            if (p.price_tier === 'Budget' && p.points_per_game > 3.5) insights.push("<li>×ª××•×¨×” ×œ××—×™×¨ (Value)</li>");
            if (p.minutes === 0) insights.push("<li>×©×—×§×Ÿ ×—×“×©/×œ×œ× ×“×§×•×ª</li>");
            if (p.xDiff < -0.5) insights.push(`<li>×‘×™×¦×•×¢×™ ×—×¡×¨ (xDiff: ${p.xDiff.toFixed(2)})</li>`);
            if (p.xDiff > 0.5) insights.push(`<li>×‘×™×¦×•×¢×™ ×™×ª×¨ (xDiff: ${p.xDiff.toFixed(2)})</li>`);
            
            if (insights.length > 0) {
                return `<ul class="insights-list">${insights.join('')}</ul>`;
            }
            return '';
        }
        
        function processChange() {
            const searchName = document.getElementById('searchName').value.toLowerCase();
            const position = document.getElementById('positionFilter').value;
            const team = document.getElementById('teamFilter').value;
            const priceRange = document.getElementById('priceRange').value;
            const minPoints = parseInt(document.getElementById('minPoints').value, 10) || 0;
            const xDiffFilter = document.getElementById('xDiffFilter').value;
            
            let [minPrice, maxPrice] = [0, 99];
            if (priceRange && priceRange.includes('-')) {
                [minPrice, maxPrice] = priceRange.split('-').map(p => parseFloat(p.trim())).filter(v => !isNaN(v));
                if (typeof maxPrice === 'undefined') maxPrice = 99;
            }
            
            let filtered = allPlayersData.filter(p => {
                const xDiffMatch = !xDiffFilter || (xDiffFilter === 'positive' && p.xDiff > 0) || (xDiffFilter === 'negative' && p.xDiff < 0);
                return p.web_name.toLowerCase().includes(searchName) && 
                       (!position || p.position_name === position) && 
                       (!team || p.team_name === team) && 
                       p.now_cost >= (minPrice || 0) && p.now_cost <= (maxPrice || 99) && 
                       p.total_points >= minPoints && 
                       xDiffMatch;
            });
            
            if (activeQuickFilterName) {
                filtered = applyQuickFilter(filtered, activeQuickFilterName);
            }

            sortAndDisplay(filtered);
        }
        
        function applyQuickFilter(data, filterName) {
            switch(filterName) {
                case 'set_pieces':
                    return data.filter(p => p.takes_penalties || p.takes_corners || p.takes_free_kicks);
                case 'attacking_defenders':
                    return data.filter(p => p.position_name === 'DEF' && p.minutes > 300);
                case 'underperformers':
                    return data.filter(p => p.minutes > 300 && p.xDiff < -1.5);
                case 'overperformers':
                    return data.filter(p => p.minutes > 300 && p.xDiff > 2.5);
                case 'differentials':
                    return data.filter(p => parseFloat(p.selected_by_percent) < 5);
                case 'newcomers':
                    return data.filter(p => p.minutes === 0);
                default:
                    return data;
            }
        }

        function sortAndDisplay(data) {
            const fields = ['rank', 'web_name', 'draft_score', 'team_name', 'position_name', 'now_cost', 'total_points', 'points_per_game', 'selected_by_percent', 'goals_scored', 'expected_goal_involvements', 'minutes', 'xDiff', 'bps', 'ict_index', 'bonus', 'clean_sheets', 'takes_free_kicks', 'verbal_insights'];
            const sortField = fields[sortColumn];

            data.sort((a, b) => {
                let valA = a[sortField];
                let valB = b[sortField];

                if (sortField === 'verbal_insights') {
                    valA = generateVerbalInsights(a);
                    valB = generateVerbalInsights(b);
                } else if (sortField === 'goals_scored') { // Special handling for G+A
                    valA = (a.goals_scored || 0) + (a.assists || 0);
                    valB = (b.goals_scored || 0) + (b.assists || 0);
                }

                if (typeof valA === 'string') {
                    return sortDirection === 'asc' ? valA.localeCompare(valB) : valB.localeCompare(valA);
                }
                return sortDirection === 'asc' ? (valA || 0) - (valB || 0) : (valB || 0) - (valA || 0);
            });

            displayedData = data;
            renderTable();
        }

        function sortTable(columnIndex) {
            if (sortColumn === columnIndex) {
                sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                sortColumn = columnIndex;
                sortDirection = 'desc';
            }
            
            document.querySelectorAll('th').forEach((th, i) => {
                const indicator = th.querySelector('.sort-indicator');
                if (indicator) { // Add this check
                    indicator.textContent = '';
                    if (i === columnIndex) {
                        th.classList.add('sorted');
                        indicator.textContent = sortDirection === 'desc' ? 'â–¼' : 'â–²'; 
                    } else {
                        th.classList.remove('sorted');
                    }
                }
            });
            processChange();
        }
        
        function toggleCompare(playerId) {
            if (selectedForComparison.has(playerId)) {
                selectedForComparison.delete(playerId);
            } else {
                selectedForComparison.add(playerId);
            }
        }

        function setActiveButton(button) {
            document.querySelectorAll('.control-button').forEach(btn => btn.classList.remove('active'));
            if (button) button.classList.add('active');
        }

        function showAllPlayers(btn) {
            setActiveButton(btn);
            activeQuickFilterName = null;
            document.querySelectorAll('.filters input, .filters select').forEach(el => {
                if (el.id !== 'showEntries' && el.id !== 'minPoints') el.value = '';
            });
            document.getElementById('minPoints').value = '0';
            processChange();
        }
        
        function quickFilter(btn, filterName) {
            const wasActive = btn.classList.contains('active');
            
            if (wasActive) {
                activeQuickFilterName = null;
                setActiveButton(document.querySelector('.control-button[onclick^="showAllPlayers"]'));
            } else {
                activeQuickFilterName = filterName;
                setActiveButton(btn);
            }
            
            // Always default sort by draft score
            sortTable(2, 'desc');
            
            processChange();
        }

        function exportToCsv() {
            const headers = ['Rank','Player','Draft Score','Team','Position','Price','Points','PPG','Selected %','G+A','xG+xA','Minutes','xDiff','BPS','ICT','Bonus','Clean Sheets','Free Kicks','Insights'];
            let csvContent = headers.join(',') + '\n';
            displayedData.forEach((p, i) => {
                const insightsText = generateVerbalInsights(p).replace(/<li>/g, '').replace(/<\/li>/g, ', ').replace(/<ul class="insights-list">/g, '').replace(/<\/ul>/g, '');
                const row = [
                    i + 1,
                    p.web_name.replace(/,/g, ''),
                    p.draft_score.toFixed(1),
                    p.team_name,
                    p.position_name,
                    p.now_cost,
                    p.total_points,
                    p.points_per_game,
                    p.selected_by_percent,
                    (p.goals_scored || 0) + (p.assists || 0),
                    p.expected_goal_involvements,
                    p.minutes,
                    p.xDiff.toFixed(2),
                    p.bps,
                    p.ict_index,
                    p.bonus,
                    p.clean_sheets,
                    p.takes_free_kicks ? 'Yes' : 'No',
                    `"${insightsText}"`
                ];
                csvContent += row.join(',') + '\n';
            });
            const blob = new Blob([`\uFEFF${csvContent}`], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            link.setAttribute("href", URL.createObjectURL(blob));
            link.setAttribute("download", "fpl_draft_data.csv");
            link.click();
        }
        
        function compareSelectedPlayers() {
            if (selectedForComparison.size < 2) {
                alert('×™×© ×œ×‘×—×•×¨ ×œ×¤×—×•×ª ×©× ×™ ×©×—×§× ×™× ×œ×”×©×•×•××”.');
                return;
            }
            const playersToCompare = allPlayersData.filter(p => selectedForComparison.has(p.id));
            const modal = document.getElementById('compareModal');
            const table = document.getElementById('compareTable');
            table.innerHTML = '';

            const headers = ['Metric', ...playersToCompare.map(p => p.web_name)];
            table.innerHTML = `<thead><tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr></thead>`;
            
            const metrics = [
                {key: 'position_name', label: '×¢××“×”', type: 'string'},
                {key: 'draft_score', label: '×¦×™×•×Ÿ ×“×¨××¤×˜', type: 'number'},
                {key: 'now_cost', label: '××—×™×¨', type: 'number', reverse: true},
                {key: 'total_points', label: '×¡×”"×› × ×§×•×“×•×ª', type: 'number'},
                {key: 'xGI_per90', label: 'xGI/90', type: 'number'},
                {key: 'xGC_per90', label: 'xGC/90', type: 'number', reverse: true},
                {key: 'xDiff', label: 'xDiff', type: 'number'},
                {key: 'ict_per_90', label: 'ICT/90', type: 'number'},
                {key: 'takes_penalties', label: '×‘×•×¢×˜ ×¤× ×“×œ×™×', type: 'boolean'},
                {key: 'takes_corners', label: '××¨×™× ×§×¨× ×•×ª', type: 'boolean'},
                {key: 'takes_free_kicks', label: '×‘×•×¢×˜ ×—×•×¤×©×™×•×ª', type: 'boolean'}
            ];

            let bodyHtml = '<tbody>';
            metrics.forEach(metric => {
                bodyHtml += `<tr><td><strong>${metric.label}</strong></td>`;
                const metricValues = playersToCompare.map(p => p[metric.key]).filter(v => typeof v === 'number');
                const min = Math.min(...metricValues);
                const max = Math.max(...metricValues);

                playersToCompare.forEach(p => {
                    const value = p[metric.key];
                    let displayValue = value;
                    let colorClass = '';
                    if (metric.type === 'string') displayValue = value;
                    else if (metric.type === 'boolean') {
                        displayValue = value ? '×›×Ÿ' : '×œ×';
                        colorClass = value ? 'value-best' : '';
                    } else if (typeof value === 'number') {
                        displayValue = value.toFixed(2);
                        colorClass = getColorClass(value, min, max, !!metric.reverse);
                    }
                    bodyHtml += `<td class="${colorClass}">${displayValue}</td>`;
                });
                bodyHtml += '</tr>';
            });
            bodyHtml += '</tbody>';
            table.innerHTML += bodyHtml;

            modal.style.display = 'block';
        }

        function getColorClass(value, min, max, reverse = false) {
            if (typeof value !== 'number' || min === max) return '';
            const normalized = (value - min) / (max - min);
            const effNorm = reverse ? 1 - normalized : normalized;
            if (effNorm > 0.95) return 'value-best';
            if (effNorm > 0.65) return 'value-good';
            if (effNorm > 0.35) return 'value-mid';
            if (effNorm > 0.05) return 'value-bad';
            return 'value-worst';
        }

        function closeModal() {
            document.getElementById('compareModal').style.display = 'none';
        }

    </script>
</body>
</html> 
